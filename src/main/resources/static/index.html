<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Spring Boot Naver Login Test</title>
    <style>
        /* ✅ 선택: 로딩 표시용 */
        #loading { display:none; font-size:14px; color:#555; }
        .btn { font-size:16px; padding:10px; margin-right:8px; }
    </style>
</head>
<body>

<h1>Naver + JWT 로그인 테스트 페이지</h1>

<a href="/oauth2/authorization/naver">
    <button style="font-size: 20px; padding: 10px;">네이버로 로그인 (먼저 하세요)</button>
</a>

<hr>

<h2>API 테스트</h2>
<button onclick="fetchUserInfo()" class="btn">내 정보 조회하기 (Access Token 사용)</button>
<button onclick="updateUserName()" class="btn">닉네임 변경 (PATCH)</button>
<button onclick="logout()" class="btn">로그아웃</button>

<!-- ✅ 추가: 리뷰 요약 -->
<h2>리뷰 요약 (toiletId=1 고정)</h2>
<button onclick="summarizeToilet1()" class="btn">요약 생성하기</button>
<span id="loading">요약 생성 중...</span>

<h3>결과:</h3>
<pre id="result"></pre>

<script>
    window.onload = function() {
        const accessToken = localStorage.getItem('accessToken');
        const refreshToken = localStorage.getItem('refreshToken');
        if (accessToken) {
            document.getElementById('result').innerText =
                '로그인 상태입니다.\n\n' +
                'Access Token: ' + accessToken.substring(0, 30) + '...\n' +
                'Refresh Token: ' + (refreshToken ? refreshToken.substring(0, 30) + '...' : '없음');
        } else {
            document.getElementById('result').innerText = '로그아웃 상태입니다.';
        }
    }

    async function fetchUserInfo() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('먼저 로그인 버튼을 눌러 로그인을 완료해주세요.');
            return;
        }
        try {
            const response = await fetch('/user/profile', {   // ✅ 프로필 조회
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            const result = await response.json();
            document.getElementById('result').innerText = JSON.stringify(result, null, 2);
        } catch (error) {
            console.error('Error fetching user info:', error);
            document.getElementById('result').innerText = '정보 조회 중 에러 발생!';
        }
    }

    async function updateUserName() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('먼저 로그인하세요.');
            return;
        }

        const newName = prompt("새로운 닉네임을 입력하세요 (2~10자):");
        if (!newName) return;

        try {
            const response = await fetch('/user/profile/name', {   // ✅ 이름 변경
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName })
            });

            const result = await response.json();
            document.getElementById('result').innerText = JSON.stringify(result, null, 2);
        } catch (error) {
            console.error('Error updating name:', error);
            document.getElementById('result').innerText = '닉네임 변경 중 에러 발생!';
        }
    }

    async function logout() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('이미 로그아웃 상태입니다.');
            return;
        }
        try {
            await fetch('/auth/logout', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            alert('로그아웃 되었습니다.');
            window.location.reload();
        } catch (error) {
            console.error('Error during logout:', error);
        }
    }

    // ✅ 추가: OpenAI 요약 호출 (toiletId=1 고정)
    async function summarizeToilet1() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('먼저 네이버 로그인 후 토큰을 발급받아 주세요.');
            return;
        }

        const loader = document.getElementById('loading');
        const resultEl = document.getElementById('result');

        try {
            loader.style.display = 'inline';

            // 컨트롤러 매핑: GET /toilet/{toiletId}/reviews/summary
            const response = await fetch('/toilet/1/reviews/summary', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });

            const payload = await response.json();

            // 표준 ApiResponse 포맷 출력
            // 성공이면 요약만 보기 쉽게 강조
            if (response.ok && payload && payload.success && payload.data && payload.data.summary) {
                resultEl.innerText =
`[요약 성공 ✅]
${payload.data.summary}

== Raw ==
${JSON.stringify(payload, null, 2)}`;
            } else {
                resultEl.innerText = JSON.stringify(payload, null, 2);
                if (response.status === 404) {
                    alert('해당 화장실에 리뷰가 없습니다.');
                } else if (response.status === 401) {
                    alert('인증이 필요합니다. 다시 로그인해 주세요.');
                }
            }
        } catch (e) {
            console.error(e);
            resultEl.innerText = '요약 생성 중 에러가 발생했습니다.';
        } finally {
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>



