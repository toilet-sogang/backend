<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>OAuth2 + JWT í†µí•© í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          text-align: center;
          margin-top: 60px;
          color: #333;
          padding-bottom: 50px; /* ìŠ¤í¬ë¡¤ ì—¬ìœ  ê³µê°„ */
        }
        h1 { font-size: 26px; margin-bottom: 20px; }
        .btn {
          display: inline-block;
          width: 220px;
          padding: 12px 16px;
          margin: 6px;
          border-radius: 6px;
          border: none;
          font-size: 15px;
          cursor: pointer;
          transition: transform 0.1s ease-in-out;
          color: #fff;
          font-weight: 500;
        }
        .btn:hover { transform: scale(1.03); }

        .google   { background-color: #DB4437; }
        .naver    { background-color: #1EC800; }
        .kakao    { background-color: #FEE500; color: #3C1E1E; }
        .facebook { background-color: #1877F2; }
        .action   { background-color: #444; }
        .info     { background-color: #555; }
        .gpt      { background-color: #8E44AD; }

        /* [! 1. ì¶”ê°€ !] íšŒì›íƒˆí‡´ìš© Danger ë²„íŠ¼ */
        .danger   { background-color: #E74C3C; }

        #loading { display:none; font-size:14px; color:#555; }
        .status {
          margin-top: 40px;
          font-size: 14px;
          color: #555;
          white-space: pre-line;
        }
        pre {
          text-align: left;
          display: inline-block;
          background: #f6f6f6;
          border-radius: 8px;
          padding: 16px;
          width: 80%;
          max-width: 800px;
          overflow-x: auto;
          line-height: 1.6;
        }

        /* [! 2. ì¶”ê°€ !] ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ CSS */
        .modal-overlay {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            border-radius: 8px;
            padding: 25px 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-content h2 { margin-top: 0; color: #E74C3C; }
        .modal-content p { white-space: pre-line; line-height: 1.7; }
        .modal-buttons { margin-top: 25px; }
        .modal-buttons .btn { width: 100px; }
        .btn-confirm { background-color: #E74C3C; }
        .btn-cancel { background-color: #95a5a6; }
    </style>
</head>
<body>

<h1>OAuth2 ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ (Naver)</h1>

<div>
    <a href="/oauth2/authorization/naver"><button class="btn naver">Naver ë¡œê·¸ì¸</button></a>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn action" onclick="reissueToken()">ğŸ”„ í† í° ì¬ë°œê¸‰</button>
    <button class="btn action" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</div>

<!-- [! 3. ì¶”ê°€ !] íšŒì›íƒˆí‡´ ë²„íŠ¼ ì„¹ì…˜ -->
<div style="margin-top: 15px;">
    <button class="btn danger" onclick="confirmWithdraw()">ğŸ”¥ íšŒì› íƒˆí‡´ (ê³„ì • ì‚­ì œ)</button>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn info" onclick="fetchUserInfo()">ğŸ‘¤ ë‚´ ì •ë³´ ì¡°íšŒ</button>
    <button class="btn info" onclick="updateUserName()">âœï¸ ë‹‰ë„¤ì„ ë³€ê²½</button>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn gpt" onclick="summarizeToilet1()">ğŸ§  ë¦¬ë·° ìš”ì•½ (toiletId=1)</button>
    <span id="loading">ìš”ì•½ ìƒì„± ì¤‘...</span>
</div>

<div class="status" id="status"></div>
<pre id="result">API ì‘ë‹µ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</pre>

<!-- [! 4. ì¶”ê°€ !] ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ HTML -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalTitle">í™•ì¸</h2>
        <p id="modalMessage">ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="modal-buttons">
            <button id="modalBtnConfirm" class="btn btn-confirm">í™•ì¸</button>
            <button id="modalBtnCancel" class="btn btn-cancel">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    // === ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™” ===
    const resultEl = document.getElementById('result');
    let onConfirmCallback = null; // ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  ì½œë°±

    window.onload = () => {
        showStatus();
        // ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.getElementById('modalBtnCancel').onclick = hideModal;
        document.getElementById('modalBtnConfirm').onclick = () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideModal();
        };
    };

    function showStatus() {
      const accessToken = localStorage.getItem('accessToken');
      const refreshToken = localStorage.getItem('refreshToken');
      const statusEl = document.getElementById('status');

      if (accessToken && refreshToken) {
        statusEl.innerText =
          'âœ… ë¡œê·¸ì¸ ìƒíƒœ\n\n' +
          'Access Token: ' + accessToken.substring(0, 25) + '...\n' +
          'Refresh Token: ' + refreshToken.substring(0, 25) + '...';
      } else {
        statusEl.innerText = 'ğŸ”’ í˜„ì¬ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.';
      }
    }

    // === [! 5. ì¶”ê°€ !] ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜ ===
    function showModal(title, message, onConfirm) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        onConfirmCallback = onConfirm;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function hideModal() {
        document.getElementById('confirmModal').style.display = 'none';
        onConfirmCallback = null;
    }

    // === [! 6. ìˆ˜ì • !] í† í° ì¬ë°œê¸‰ (alert -> resultEl) ===
    async function reissueToken() {
      const refreshToken = localStorage.getItem('refreshToken');
      if (!refreshToken) {
        resultEl.innerText = 'âŒ ì¬ë°œê¸‰ ì‹¤íŒ¨: Refresh Tokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.';
        return;
      }

      resultEl.innerText = 'í† í° ì¬ë°œê¸‰ ìš”ì²­ ì¤‘...';

      try {
        const res = await fetch('/auth/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });
        const result = await res.json();

        if (res.ok && result.success) {
          localStorage.setItem('accessToken', result.data.accessToken);
          localStorage.setItem('refreshToken', result.data.refreshToken);
          resultEl.innerText = 'ğŸ”„ í† í° ì¬ë°œê¸‰ ì„±ê³µ!\n' + JSON.stringify(result, null, 2);
          showStatus();
        } else {
          resultEl.innerText = 'âŒ ì¬ë°œê¸‰ ì‹¤íŒ¨: \n' + JSON.stringify(result, null, 2);
        }
      } catch (err) {
        console.error(err);
        resultEl.innerText = 'âŒ ì¬ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + err.message;
      }
    }

    // === [! 7. ìˆ˜ì • !] ë¡œê·¸ì•„ì›ƒ (alert -> resultEl) ===
    async function logout() {
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) {
        resultEl.innerText = 'ğŸ”’ ì´ë¯¸ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.';
        return;
      }

      resultEl.innerText = 'ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì¤‘...';

      try {
        const res = await fetch('/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });

        // 204 No Content ë˜ëŠ” 200 OK ëª¨ë‘ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
        if (res.ok) {
            localStorage.clear();
            resultEl.innerText = 'ğŸšª ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!';
            showStatus();
        } else {
            const result = await res.json();
            resultEl.innerText = 'âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: \n' + JSON.stringify(result, null, 2);
        }
      } catch (err) {
        console.error(err);
        resultEl.innerText = 'âŒ ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + err.message;
      }
    }

    // === [! 8. ì¶”ê°€ !] íšŒì› íƒˆí‡´ í™•ì¸ì°½ ë„ìš°ê¸° ===
    function confirmWithdraw() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            resultEl.innerText = 'ğŸ”¥ íšŒì› íƒˆí‡´ ì‹¤íŒ¨: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.';
            return;
        }

        // ì‹¤ì œ íƒˆí‡´ ë¡œì§(withdrawUser)ì„ ì½œë°±ìœ¼ë¡œ ë„˜ê²¨ ëª¨ë‹¬ì„ ë„ì›€
        showModal(
            'ğŸ”¥ íšŒì› íƒˆí‡´',
            'ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ë¦¬ë·°ì™€ ì´ë¯¸ì§€ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©°,\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
            withdrawUser // 'í™•ì¸' ëˆ„ë¥´ë©´ ì‹¤í–‰ë  í•¨ìˆ˜
        );
    }

    // === [! 9. ì¶”ê°€ !] ì‹¤ì œ íšŒì› íƒˆí‡´ API í˜¸ì¶œ ===
    async function withdrawUser() {
        const token = localStorage.getItem('accessToken');
        if (!token) return; // (confirmWithdrawì—ì„œ ì´ë¯¸ ì²´í¬í•¨)

        resultEl.innerText = 'ğŸ”¥ íšŒì› íƒˆí‡´ ìš”ì²­ ì¤‘... (ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤)';

        try {
            const res = await fetch('/auth/withdraw', {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            // 204 No Content (ì„±ê³µ)
            if (res.status === 204) {
                localStorage.clear();
                resultEl.innerText = 'âœ… íšŒì› íƒˆí‡´ê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
                showStatus();
            } else {
                // 4xx, 5xx ì—ëŸ¬ (JSON ì‘ë‹µì´ ìˆì„ ê²½ìš°)
                const data = await res.json();
                resultEl.innerText = `ğŸ”¥ íšŒì› íƒˆí‡´ ì‹¤íŒ¨ (Code: ${res.status}):\n${JSON.stringify(data, null, 2)}`;
            }
        } catch (err) {
            console.error(err);
            resultEl.innerText = 'ğŸ”¥ íšŒì› íƒˆí‡´ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ:\n' + err.message;
        }
    }


    // === ë‚´ ì •ë³´ ì¡°íšŒ (ê¸°ì¡´ê³¼ ë™ì¼) ===
    async function fetchUserInfo() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        resultEl.innerText = 'âŒ ë‚´ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.';
        return;
      }
      resultEl.innerText = 'ë‚´ ì •ë³´ ì¡°íšŒ ì¤‘...';
      const res = await fetch('/user/profile', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      resultEl.innerText = JSON.stringify(data, null, 2);
    }

    // === ë‹‰ë„¤ì„ ë³€ê²½ (ê¸°ì¡´ê³¼ ë™ì¼) ===
    async function updateUserName() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        resultEl.innerText = 'âŒ ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨: ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.';
        return;
      }
      const newName = prompt('ìƒˆ ë‹‰ë„¤ì„ (2~10ì):');
      if (!newName) return;

      resultEl.innerText = 'ë‹‰ë„¤ì„ ë³€ê²½ ìš”ì²­ ì¤‘...';
      const res = await fetch('/user/profile/name', {
        method: 'PATCH',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName })
      });
      const data = await res.json();
      resultEl.innerText = JSON.stringify(data, null, 2);
    }

    // === ë¦¬ë·° ìš”ì•½ (ê¸°ì¡´ê³¼ ë™ì¼) ===
    async function summarizeToilet1() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        resultEl.innerText = 'âŒ ìš”ì•½ ì‹¤íŒ¨: ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.';
        return;
      }

      const loader = document.getElementById('loading');
      loader.style.display = 'inline';
      resultEl.innerText = 'GPT ë¦¬ë·° ìš”ì•½ ìƒì„± ì¤‘... (ìµœëŒ€ 10~15ì´ˆ ì†Œìš”)';

      try {
        const res = await fetch('/toilet/1/reviews/summary', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();

        if (res.ok && data.success && data.data?.summary) {
          resultEl.innerText =
            `[ìš”ì•½ ì„±ê³µ âœ…]\n${data.data.summary}\n\n== Raw ==\n` +
            JSON.stringify(data, null, 2);
        } else {
          resultEl.innerText = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        console.error(err);
        resultEl.innerText = 'âŒ ìš”ì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + err.message;
      } finally {
        loader.style.display = 'none';
      }
    }
</script>

</body>
</html>