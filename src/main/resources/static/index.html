<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>OAuth2 + JWT 통합 테스트 대시보드</title>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          text-align: center;
          margin-top: 60px;
          color: #333;
        }
        h1 { font-size: 26px; margin-bottom: 20px; }
        .btn {
          display: inline-block;
          width: 220px;
          padding: 12px 16px;
          margin: 6px;
          border-radius: 6px;
          border: none;
          font-size: 15px;
          cursor: pointer;
          transition: transform 0.1s ease-in-out;
          color: #fff;
        }
        .btn:hover { transform: scale(1.03); }

        .google   { background-color: #DB4437; }
        .naver    { background-color: #1EC800; }
        .kakao    { background-color: #FEE500; color: #3C1E1E; }
        .facebook { background-color: #1877F2; }
        .action   { background-color: #444; }
        .info     { background-color: #555; }
        .gpt      { background-color: #8E44AD; }

        #loading { display:none; font-size:14px; color:#555; }
        .status {
          margin-top: 40px;
          font-size: 14px;
          color: #555;
          white-space: pre-line;
        }
        pre {
          text-align: left;
          display: inline-block;
          background: #f6f6f6;
          border-radius: 8px;
          padding: 16px;
          width: 80%;
          max-width: 800px;
          overflow-x: auto;
        }
    </style>
</head>
<body>

<h1>OAuth2 로그인 테스트 (Naver)</h1>

<div>
    <a href="/oauth2/authorization/naver"><button class="btn naver">Naver 로그인</button></a>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn action" onclick="reissueToken()">🔄 토큰 재발급</button>
    <button class="btn action" onclick="logout()">🚪 로그아웃</button>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn info" onclick="fetchUserInfo()">👤 내 정보 조회</button>
    <button class="btn info" onclick="updateUserName()">✏️ 닉네임 변경</button>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn gpt" onclick="summarizeToilet1()">🧠 리뷰 요약 (toiletId=1)</button>
    <span id="loading">요약 생성 중...</span>
</div>

<div class="status" id="status"></div>
<pre id="result"></pre>

<script>
    window.onload = showStatus;

    function showStatus() {
      const accessToken = localStorage.getItem('accessToken');
      const refreshToken = localStorage.getItem('refreshToken');
      const statusEl = document.getElementById('status');

      if (accessToken && refreshToken) {
        statusEl.innerText =
          '✅ 로그인 상태\n\n' +
          'Access Token: ' + accessToken.substring(0, 25) + '...\n' +
          'Refresh Token: ' + refreshToken.substring(0, 25) + '...';
      } else {
        statusEl.innerText = '🔒 현재 로그아웃 상태입니다.';
      }
    }

    // === 토큰 재발급 ===
    async function reissueToken() {
      const refreshToken = localStorage.getItem('refreshToken');
      if (!refreshToken) return alert('Refresh Token이 없습니다. 먼저 로그인하세요.');

      try {
        const res = await fetch('/auth/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });
        const result = await res.json();

        if (res.ok && result.success) {
          localStorage.setItem('accessToken', result.data.accessToken);
          localStorage.setItem('refreshToken', result.data.refreshToken);
          alert('🔄 토큰 재발급 성공!');
          showStatus();
        } else {
          alert('❌ 재발급 실패: ' + result.message);
        }
      } catch (err) {
        console.error(err);
        alert('재발급 중 오류 발생');
      }
    }

    // === 로그아웃 ===
    async function logout() {
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) return alert('이미 로그아웃 상태입니다.');

      try {
        await fetch('/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        localStorage.clear();
        alert('🚪 로그아웃 완료!');
        showStatus();
      } catch (err) {
        console.error(err);
      }
    }

    // === 내 정보 조회 ===
    async function fetchUserInfo() {
      const token = localStorage.getItem('accessToken');
      if (!token) return alert('로그인 후 이용하세요.');
      const res = await fetch('/user/profile', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      document.getElementById('result').innerText = JSON.stringify(data, null, 2);
    }

    // === 닉네임 변경 ===
    async function updateUserName() {
      const token = localStorage.getItem('accessToken');
      if (!token) return alert('로그인 후 이용하세요.');
      const newName = prompt('새 닉네임 (2~10자):');
      if (!newName) return;

      const res = await fetch('/user/profile/name', {
        method: 'PATCH',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName })
      });
      const data = await res.json();
      document.getElementById('result').innerText = JSON.stringify(data, null, 2);
    }

    // === 리뷰 요약 ===
    async function summarizeToilet1() {
      const token = localStorage.getItem('accessToken');
      if (!token) return alert('로그인 후 이용하세요.');

      const loader = document.getElementById('loading');
      const resultEl = document.getElementById('result');
      loader.style.display = 'inline';

      try {
        const res = await fetch('/toilet/1/reviews/summary', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();

        if (res.ok && data.success && data.data?.summary) {
          resultEl.innerText =
            `[요약 성공 ✅]\n${data.data.summary}\n\n== Raw ==\n` +
            JSON.stringify(data, null, 2);
        } else {
          resultEl.innerText = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        console.error(err);
        resultEl.innerText = '요약 중 오류 발생';
      } finally {
        loader.style.display = 'none';
      }
    }
</script>

</body>
</html>
