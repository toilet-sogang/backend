<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>OAuth2 + JWT í†µí•© í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          text-align: center;
          margin-top: 60px;
          color: #333;
        }
        h1 { font-size: 26px; margin-bottom: 20px; }
        .btn {
          display: inline-block;
          width: 220px;
          padding: 12px 16px;
          margin: 6px;
          border-radius: 6px;
          border: none;
          font-size: 15px;
          cursor: pointer;
          transition: transform 0.1s ease-in-out;
          color: #fff;
        }
        .btn:hover { transform: scale(1.03); }

        .google   { background-color: #DB4437; }
        .naver    { background-color: #1EC800; }
        .kakao    { background-color: #FEE500; color: #3C1E1E; }
        .facebook { background-color: #1877F2; }
        .action   { background-color: #444; }
        .info     { background-color: #555; }
        .gpt      { background-color: #8E44AD; }

        #loading { display:none; font-size:14px; color:#555; }
        .status {
          margin-top: 40px;
          font-size: 14px;
          color: #555;
          white-space: pre-line;
        }
        pre {
          text-align: left;
          display: inline-block;
          background: #f6f6f6;
          border-radius: 8px;
          padding: 16px;
          width: 80%;
          max-width: 800px;
          overflow-x: auto;
        }
    </style>
</head>
<body>

<h1>OAuth2 ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ (Naver)</h1>

<div>
    <a href="/oauth2/authorization/naver"><button class="btn naver">Naver ë¡œê·¸ì¸</button></a>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn action" onclick="reissueToken()">ğŸ”„ í† í° ì¬ë°œê¸‰</button>
    <button class="btn action" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn info" onclick="fetchUserInfo()">ğŸ‘¤ ë‚´ ì •ë³´ ì¡°íšŒ</button>
    <button class="btn info" onclick="updateUserName()">âœï¸ ë‹‰ë„¤ì„ ë³€ê²½</button>
</div>

<hr style="margin: 30px 0; width: 70%;">

<div>
    <button class="btn gpt" onclick="summarizeToilet1()">ğŸ§  ë¦¬ë·° ìš”ì•½ (toiletId=1)</button>
    <span id="loading">ìš”ì•½ ìƒì„± ì¤‘...</span>
</div>

<div class="status" id="status"></div>
<pre id="result"></pre>

<script>
    window.onload = showStatus;

    function showStatus() {
      const accessToken = localStorage.getItem('accessToken');
      const refreshToken = localStorage.getItem('refreshToken');
      const statusEl = document.getElementById('status');

      if (accessToken && refreshToken) {
        statusEl.innerText =
          'âœ… ë¡œê·¸ì¸ ìƒíƒœ\n\n' +
          'Access Token: ' + accessToken.substring(0, 25) + '...\n' +
          'Refresh Token: ' + refreshToken.substring(0, 25) + '...';
      } else {
        statusEl.innerText = 'ğŸ”’ í˜„ì¬ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.';
      }
    }

    // === í† í° ì¬ë°œê¸‰ ===
    async function reissueToken() {
      const refreshToken = localStorage.getItem('refreshToken');
      if (!refreshToken) return alert('Refresh Tokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');

      try {
        const res = await fetch('/auth/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });
        const result = await res.json();

        if (res.ok && result.success) {
          localStorage.setItem('accessToken', result.data.accessToken);
          localStorage.setItem('refreshToken', result.data.refreshToken);
          alert('ğŸ”„ í† í° ì¬ë°œê¸‰ ì„±ê³µ!');
          showStatus();
        } else {
          alert('âŒ ì¬ë°œê¸‰ ì‹¤íŒ¨: ' + result.message);
        }
      } catch (err) {
        console.error(err);
        alert('ì¬ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      }
    }

    // === ë¡œê·¸ì•„ì›ƒ ===
    async function logout() {
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) return alert('ì´ë¯¸ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.');

      try {
        await fetch('/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        localStorage.clear();
        alert('ğŸšª ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!');
        showStatus();
      } catch (err) {
        console.error(err);
      }
    }

    // === ë‚´ ì •ë³´ ì¡°íšŒ ===
    async function fetchUserInfo() {
      const token = localStorage.getItem('accessToken');
      if (!token) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.');
      const res = await fetch('/user/profile', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      document.getElementById('result').innerText = JSON.stringify(data, null, 2);
    }

    // === ë‹‰ë„¤ì„ ë³€ê²½ ===
    async function updateUserName() {
      const token = localStorage.getItem('accessToken');
      if (!token) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.');
      const newName = prompt('ìƒˆ ë‹‰ë„¤ì„ (2~10ì):');
      if (!newName) return;

      const res = await fetch('/user/profile/name', {
        method: 'PATCH',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName })
      });
      const data = await res.json();
      document.getElementById('result').innerText = JSON.stringify(data, null, 2);
    }

    // === ë¦¬ë·° ìš”ì•½ ===
    async function summarizeToilet1() {
      const token = localStorage.getItem('accessToken');
      if (!token) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.');

      const loader = document.getElementById('loading');
      const resultEl = document.getElementById('result');
      loader.style.display = 'inline';

      try {
        const res = await fetch('/toilet/1/reviews/summary', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();

        if (res.ok && data.success && data.data?.summary) {
          resultEl.innerText =
            `[ìš”ì•½ ì„±ê³µ âœ…]\n${data.data.summary}\n\n== Raw ==\n` +
            JSON.stringify(data, null, 2);
        } else {
          resultEl.innerText = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        console.error(err);
        resultEl.innerText = 'ìš”ì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
      } finally {
        loader.style.display = 'none';
      }
    }
</script>

</body>
</html>
